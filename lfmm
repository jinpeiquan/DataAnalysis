##############################################################################
# å®Œæ•´çš„LFMMåˆ†æä»£ç  - ä½¿ç”¨ä¿®æ­£æ–¹æ³•æå–SVæ ‡è¯†ç¬¦
##############################################################################

# æ¸…ç©ºå·¥ä½œç©ºé—´
rm(list = ls())
gc()

# åŠ è½½å¿…è¦çš„åŒ…
library(lfmm)
library(qvalue)  
library(data.table)
library(LEA)

# è®¾ç½®å·¥ä½œç›®å½•
setwd("D:/QFIELS/200sample/SV/GEA/LFMM/GF/lfmm")
cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd(), "\n\n")

##############################################################################
# ç¬¬ä¸€æ­¥ï¼šä».rawæ–‡ä»¶æå–SVæ ‡è¯†ç¬¦ï¼ˆä¿®æ­£æ–¹æ³•ï¼‰
##############################################################################

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬ä¸€æ­¥ï¼šä».rawæ–‡ä»¶æå–SVæ ‡è¯†ç¬¦ï¼ˆä¿®æ­£æ–¹æ³•ï¼‰\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("æ­£åœ¨ä½¿ç”¨ä¿®æ­£æ–¹æ³•æå–SVæ ‡è¯†ç¬¦...\n")

# æ–¹æ³•ï¼šç›´æ¥è¯»å–ç¬¬ä¸€è¡Œå¹¶å¤„ç†SVåç§°
tryCatch({
  # è¯»å–.rawæ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼ˆè¡¨å¤´è¡Œï¼‰
  first_line <- readLines("200_samples_sv.plink.recodeA.raw", n = 1)
  
  # åˆ†å‰²è¡¨å¤´ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰
  header_parts <- strsplit(first_line, "\\s+")[[1]]
  cat("è¡¨å¤´æ€»åˆ—æ•°ï¼š", length(header_parts), "\n")
  
  # æ˜¾ç¤ºè¡¨å¤´ç»“æ„
  cat("\nè¡¨å¤´ç»“æ„ï¼ˆå‰15åˆ—ï¼‰ï¼š\n")
  for (i in 1:min(15, length(header_parts))) {
    cat(sprintf("  %3d. %s\n", i, header_parts[i]))
  }
  
  # æå–SVæ ‡è¯†ç¬¦ï¼ˆä»ç¬¬7åˆ—å¼€å§‹ï¼‰
  sv_full_names <- header_parts[7:length(header_parts)]
  cat("\nSVåŸå§‹åç§°æ•°é‡ï¼š", length(sv_full_names), "\n")
  
  # å»é™¤æœ«å°¾çš„ç­‰ä½åŸºå› åç¼€
  sv_ids <- sub("_[^_]+$", "", sv_full_names)
  
  cat("å¤„ç†åçš„SVæ ‡è¯†ç¬¦æ•°é‡ï¼š", length(sv_ids), "\n\n")
  
  # æ˜¾ç¤ºå‰åå¯¹æ¯”
  cat("SVæ ‡è¯†ç¬¦è½¬æ¢ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰ï¼š\n")
  cat("åŸå§‹åç§° -> å¤„ç†åæ ‡è¯†ç¬¦\n")
  cat(paste(rep("-", 40), collapse = ""), "\n")
  
  for (i in 1:min(10, length(sv_ids))) {
    cat(sprintf("%-20s -> %-20s\n", 
                substr(sv_full_names[i], 1, 20), 
                substr(sv_ids[i], 1, 20)))
  }
  
  # æ£€æŸ¥é‡å¤
  dup_counts <- sum(duplicated(sv_ids))
  if (dup_counts > 0) {
    cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", dup_counts, "ä¸ªé‡å¤çš„SVæ ‡è¯†ç¬¦\n")
    dup_ids <- sv_ids[duplicated(sv_ids)]
    cat("é‡å¤çš„æ ‡è¯†ç¬¦ï¼ˆå‰5ä¸ªï¼‰ï¼š\n")
    for (i in 1:min(5, length(dup_ids))) {
      cat("  ", dup_ids[i], "\n")
    }
    
    # ä½¿ç”¨make.uniqueå¤„ç†é‡å¤
    sv_ids <- make.unique(sv_ids, sep = "_dup")
    cat("å·²ä½¿ç”¨make.uniqueä¿®å¤é‡å¤æ ‡è¯†ç¬¦\n")
    
    # è®°å½•é‡å¤å¤„ç†æƒ…å†µ
    dup_positions <- which(duplicated(sub("_[^_]+$", "", sv_full_names)))
    if (length(dup_positions) > 0) {
      cat("\né‡å¤SVçš„è¯¦ç»†ä¿¡æ¯ï¼š\n")
      for (pos in dup_positions) {
        original_name <- sv_full_names[pos]
        processed_name <- sv_ids[pos]
        cat(sprintf("  ä½ç½® %d: %s -> %s\n", 
                    pos, 
                    substr(original_name, 1, 50), 
                    processed_name))
      }
    }
  } else {
    cat("\nâœ“ æ²¡æœ‰å‘ç°é‡å¤çš„SVæ ‡è¯†ç¬¦\n")
  }
  
  # æ£€æŸ¥ç©ºå€¼æˆ–æ— æ•ˆå€¼
  invalid_indices <- which(is.na(sv_ids) | sv_ids == "" | sv_ids == "NA")
  if (length(invalid_indices) > 0) {
    cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", length(invalid_indices), "ä¸ªæ— æ•ˆSVæ ‡è¯†ç¬¦\n")
    
    # ä¿®å¤æ— æ•ˆå€¼
    for (i in invalid_indices) {
      sv_ids[i] <- paste0("SV_", i)
    }
    cat("å·²ä¿®å¤æ— æ•ˆæ ‡è¯†ç¬¦\n")
  }
  
  cat("\næœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š\n")
  cat("  æ€»æ•°ï¼š", length(sv_ids), "\n")
  
  # éªŒè¯æå–æ˜¯å¦æˆåŠŸ
  cat("\néªŒè¯æå–ç»“æœï¼š\n")
  test_indices <- c(1, 10, 100, 1000, 10000)
  test_indices <- test_indices[test_indices <= length(sv_ids)]
  
  for (i in seq_along(test_indices)) {
    idx <- test_indices[i]
    original <- sv_full_names[idx]
    processed <- sv_ids[idx]
    cat(sprintf("  %6d: %-25s -> %-25s\n", 
                idx, 
                substr(original, 1, 25), 
                processed))
  }
  
}, error = function(e) {
  cat("SVæ ‡è¯†ç¬¦æå–å¤±è´¥ï¼š", e$message, "\n")
  cat("å°è¯•å¤‡ç”¨æ–¹æ³•...\n")
  
  # å¤‡ç”¨æ–¹æ³•
  raw_sample <- fread("200_samples_sv.plink.recodeA.raw", 
                      nrows = 5, 
                      header = TRUE)
  
  all_cols <- colnames(raw_sample)
  sv_cols <- all_cols[7:length(all_cols)]
  sv_ids <- sub("_[^_]+$", "", sv_cols)
  sv_ids <- make.unique(sv_ids, sep = "_dup")  # ä»ç„¶ä½¿ç”¨make.unique
  
  cat("ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æå–åˆ°", length(sv_ids), "ä¸ªSVæ ‡è¯†ç¬¦\n")
})

cat("\nSVæ ‡è¯†ç¬¦æå–å®Œæˆï¼\n")
cat("SVæ•°é‡ï¼š", length(sv_ids), "\n")

##############################################################################
# ç¬¬äºŒæ­¥ï¼šè¯»å–ç¯å¢ƒå› å­æ•°æ®
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬äºŒæ­¥ï¼šè¯»å–ç¯å¢ƒå› å­æ•°æ®\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("æ­£åœ¨è¯»å–ç¯å¢ƒå› å­æ•°æ®...\n")
X <- read.csv("Climate_current_200samples.csv", header = TRUE, row.names = 1)

# æå–BIO1-BIO19
X_env <- X[, 3:21]
cat("ç¯å¢ƒæ•°æ®ç»´åº¦ï¼š", dim(X_env), "\n")
cat("ç¯å¢ƒå› å­åç§°ï¼š", paste(colnames(X_env), collapse = ", "), "\n")

# æ ‡å‡†åŒ–ç¯å¢ƒæ•°æ®
cat("\næ ‡å‡†åŒ–ç¯å¢ƒæ•°æ®...\n")
X_env_scaled <- as.data.frame(scale(X_env))
cat("æ ‡å‡†åŒ–å®Œæˆ\n")

##############################################################################
# ç¬¬ä¸‰æ­¥ï¼šè¯»å–åŸºå› å‹æ•°æ®ï¼ˆ.lfmmæ ¼å¼ï¼‰
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬ä¸‰æ­¥ï¼šè¯»å–åŸºå› å‹æ•°æ®\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("æ­£åœ¨è¯»å–åŸºå› å‹æ•°æ®ï¼ˆ.lfmmæ ¼å¼ï¼‰...\n")
Y <- fread("200_samples_sv.plink.recodeA.lfmm", header = FALSE)
Y_matrix <- as.matrix(Y)
cat("åŸºå› å‹æ•°æ®ç»´åº¦ï¼š", dim(Y_matrix), "\n")

##############################################################################
# ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

# æ£€æŸ¥SVæ•°é‡æ˜¯å¦åŒ¹é…
if (ncol(Y_matrix) != length(sv_ids)) {
  cat("âš ï¸ è­¦å‘Šï¼šSVæ ‡è¯†ç¬¦æ•°é‡ï¼ˆ", length(sv_ids), 
      "ï¼‰ä¸åŸºå› å‹æ•°æ®SVæ•°é‡ï¼ˆ", ncol(Y_matrix), "ï¼‰ä¸åŒ¹é…\n")
  
  min_count <- min(length(sv_ids), ncol(Y_matrix))
  sv_ids <- sv_ids[1:min_count]
  Y_matrix <- Y_matrix[, 1:min_count]
  
  cat("å·²è°ƒæ•´ä¸º", min_count, "ä¸ªSV\n")
} else {
  cat("âœ“ SVæ•°é‡åŒ¹é…ï¼š", length(sv_ids), "ä¸ªSV\n")
}

# æ£€æŸ¥æ ·æœ¬æ•°æ˜¯å¦åŒ¹é…
if (nrow(X_env_scaled) != nrow(Y_matrix)) {
  cat("\nâŒ é”™è¯¯ï¼šæ ·æœ¬æ•°ä¸åŒ¹é…ï¼\n")
  cat("  ç¯å¢ƒæ•°æ®æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
  cat("  åŸºå› å‹æ•°æ®æ ·æœ¬æ•°ï¼š", nrow(Y_matrix), "\n")
  stop("è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼Œç¡®ä¿æ ·æœ¬é¡ºåºä¸€è‡´")
} else {
  cat("âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š", nrow(X_env_scaled), "ä¸ªæ ·æœ¬\n")
}

cat("\næ•°æ®ç»´åº¦ï¼š\n")
cat("  Xï¼ˆç¯å¢ƒï¼‰ï¼š", dim(X_env_scaled), "\n")
cat("  Yï¼ˆåŸºå› å‹ï¼‰ï¼š", dim(Y_matrix), "\n")

##############################################################################
# åç»­æ­¥éª¤ç»§ç»­æ‚¨çš„åŸä»£ç ...
# ï¼ˆè¿™é‡Œä»ç¬¬äº”æ­¥å¼€å§‹ï¼Œä¿æŒæ‚¨åŸæœ‰çš„ä»£ç ç»“æ„ä¸å˜ï¼‰
##############################################################################

# ä¿å­˜SVæ ‡è¯†ç¬¦ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
saveRDS(sv_ids, file = "sv_ids_processed.rds")
cat("\nSVæ ‡è¯†ç¬¦å·²ä¿å­˜ä¸ºï¼šsv_ids_processed.rds\n")

# ç»§ç»­æ‰§è¡Œæ‚¨åŸæ¥çš„LFMMåˆ†æä»£ç 
# ä»ç¬¬äº”æ­¥ï¼šè®¾ç½®åˆ†æå‚æ•° å¼€å§‹ç»§ç»­...

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("SVæ ‡è¯†ç¬¦æå–å®Œæˆï¼Œå‡†å¤‡è¿›è¡ŒLFMMåˆ†æ\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

# æ³¨æ„ï¼šåç»­çš„LFMMåˆ†æä»£ç ä¿æŒä¸å˜
# åªéœ€è¦ç¡®ä¿åœ¨è®¾ç½®è¡Œåˆ—åæ—¶ä½¿ç”¨è¿™ä¸ªå¤„ç†åçš„sv_ids

cat("æ­£åœ¨è¯»å–åŸºå› å‹æ•°æ®ï¼ˆ.lfmmæ ¼å¼ï¼‰...\n")
Y <- fread("200_samples_sv.plink.recodeA.lfmm", header = FALSE)
Y_matrix <- as.matrix(Y)
cat("åŸºå› å‹æ•°æ®ç»´åº¦ï¼š", dim(Y_matrix), "\n")

##############################################################################
# ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

# æ£€æŸ¥SVæ•°é‡æ˜¯å¦åŒ¹é…
if (ncol(Y_matrix) != length(sv_ids)) {
  cat("âš ï¸ è­¦å‘Šï¼šSVæ ‡è¯†ç¬¦æ•°é‡ï¼ˆ", length(sv_ids), 
      "ï¼‰ä¸åŸºå› å‹æ•°æ®SVæ•°é‡ï¼ˆ", ncol(Y_matrix), "ï¼‰ä¸åŒ¹é…\n")
  
  min_count <- min(length(sv_ids), ncol(Y_matrix))
  sv_ids <- sv_ids[1:min_count]
  Y_matrix <- Y_matrix[, 1:min_count]
  
  cat("å·²è°ƒæ•´ä¸º", min_count, "ä¸ªSV\n")
} else {
  cat("âœ“ SVæ•°é‡åŒ¹é…ï¼š", length(sv_ids), "ä¸ªSV\n")
}

# æ£€æŸ¥æ ·æœ¬æ•°æ˜¯å¦åŒ¹é…
if (nrow(X_env_scaled) != nrow(Y_matrix)) {
  cat("\nâŒ é”™è¯¯ï¼šæ ·æœ¬æ•°ä¸åŒ¹é…ï¼\n")
  cat("  ç¯å¢ƒæ•°æ®æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
  cat("  åŸºå› å‹æ•°æ®æ ·æœ¬æ•°ï¼š", nrow(Y_matrix), "\n")
  stop("è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼Œç¡®ä¿æ ·æœ¬é¡ºåºä¸€è‡´")
} else {
  cat("âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š", nrow(X_env_scaled), "ä¸ªæ ·æœ¬\n")
}

cat("\næ•°æ®ç»´åº¦ï¼š\n")
cat("  Xï¼ˆç¯å¢ƒï¼‰ï¼š", dim(X_env_scaled), "\n")
cat("  Yï¼ˆåŸºå› å‹ï¼‰ï¼š", dim(Y_matrix), "\n")

##############################################################################
# ç¬¬äº”æ­¥ï¼šè®¾ç½®åˆ†æå‚æ•°
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬äº”æ­¥ï¼šè®¾ç½®åˆ†æå‚æ•°\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

# è®¾ç½®Kå€¼ï¼ˆæ½œåœ¨å› å­æ•°é‡ï¼‰
# æ³¨æ„ï¼šæ‚¨éœ€è¦æ ¹æ®ç¾¤ä½“ç»“æ„åˆ†æç¡®å®šæœ€ä½³Kå€¼
K <- 6  # è¿™é‡Œè®¾ä¸º6ï¼Œæ‚¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

cat("Kå€¼ï¼ˆæ½œåœ¨å› å­æ•°é‡ï¼‰ï¼š", K, "\n")
cat("æç¤ºï¼šKå€¼çš„é€‰æ‹©å¯¹ç»“æœå¾ˆé‡è¦ï¼Œå»ºè®®æ ¹æ®ç¾¤ä½“ç»“æ„åˆ†æç¡®å®š\n")

##############################################################################
# ç¬¬å…­æ­¥ï¼šLFMMæ¨¡å‹æ‹Ÿåˆ
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬å…­æ­¥ï¼šLFMMæ¨¡å‹æ‹Ÿåˆ\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("å¼€å§‹LFMMæ¨¡å‹æ‹Ÿåˆ...\n")
cat("åˆ†æå‚æ•°ï¼š\n")
cat("  æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
cat("  SVæ•°é‡ï¼š", ncol(Y_matrix), "\n")
cat("  ç¯å¢ƒå› å­æ•°ï¼š", ncol(X_env_scaled), "\n")
cat("  Kå€¼ï¼š", K, "\n")

start_time <- Sys.time()
cat("å¼€å§‹æ—¶é—´ï¼š", format(start_time, "%H:%M:%S"), "\n")

# è¿è¡ŒLFMMæ¨¡å‹
mod.lfmm <- lfmm::lfmm_ridge(Y = Y_matrix,
                             X = as.matrix(X_env_scaled),
                             K = K)

end_time <- Sys.time()
cat("LFMMæ¨¡å‹æ‹Ÿåˆå®Œæˆï¼Œè€—æ—¶ï¼š", round(end_time - start_time, 2), "ç§’\n")

##############################################################################
# ç¬¬ä¸ƒæ­¥ï¼šè®¡ç®—på€¼ï¼ˆä½¿ç”¨GIFæ ¡æ­£ï¼‰
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬ä¸ƒæ­¥ï¼šè®¡ç®—på€¼ï¼ˆä½¿ç”¨GIFæ ¡æ­£ï¼‰\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("æ­£åœ¨è®¡ç®—på€¼...\n")
start_time <- Sys.time()

pv <- lfmm::lfmm_test(Y = Y_matrix, 
                      X = as.matrix(X_env_scaled), 
                      lfmm = mod.lfmm,
                      calibrate = "gif")

end_time <- Sys.time()
cat("på€¼è®¡ç®—å®Œæˆï¼Œè€—æ—¶ï¼š", round(end_time - start_time, 2), "ç§’\n")

# ä¿å­˜ç»“æœ
saveRDS(pv, file = "pv_results_200samples_SV_bio1_19_corrected.rds")
cat("ç»“æœå·²ä¿å­˜ä¸ºï¼špv_results_200samples_SV_bio1_19_corrected.rds\n")

# åŠ è½½ç»“æœ
pv <- readRDS("pv_results_200samples_SV_bio1_19_corrected.rds")

cat("åŸºå› ç»„è†¨èƒ€å› å­ï¼ˆGIFï¼‰ï¼š", round(pv$gif, 3), "\n")

##############################################################################
# ç¬¬å…«æ­¥ï¼šæå–å’Œä¿å­˜på€¼
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬å…«æ­¥ï¼šæå–å’Œä¿å­˜på€¼\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

raw_pvalues <- pv$pvalue
calibrated_pvalues <- pv$calibrated.pvalue

cat("åŸå§‹på€¼çŸ©é˜µç»´åº¦ï¼š", dim(raw_pvalues), "\n")
cat("æ ¡æ­£på€¼çŸ©é˜µç»´åº¦ï¼š", dim(calibrated_pvalues), "\n")

# è®¾ç½®è¡Œåˆ—å - å…³é”®æ­¥éª¤ï¼šä½¿ç”¨å¤„ç†åçš„sv_ids
rownames(raw_pvalues) <- sv_ids
rownames(calibrated_pvalues) <- sv_ids
colnames(raw_pvalues) <- colnames(X_env_scaled)
colnames(calibrated_pvalues) <- colnames(X_env_scaled)

# ä¿å­˜åŸå§‹på€¼
write.csv(raw_pvalues, file = "SV_raw_pvalues_bio1_19_corrected.csv")
cat("åŸå§‹på€¼å·²ä¿å­˜ä¸ºï¼šSV_raw_pvalues_bio1_19_corrected.csv\n")

# ä¿å­˜æ ¡æ­£på€¼
write.csv(calibrated_pvalues, file = "SV_calibrated_pvalues_bio1_19_corrected.csv")
cat("æ ¡æ­£på€¼å·²ä¿å­˜ä¸ºï¼šSV_calibrated_pvalues_bio1_19_corrected.csv\n")

##############################################################################
# ç¬¬ä¹æ­¥ï¼šFDRæ ¡æ­£ï¼ˆè®¡ç®—qå€¼ï¼‰
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬ä¹æ­¥ï¼šFDRæ ¡æ­£ï¼ˆè®¡ç®—qå€¼ï¼‰\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

num_env_factors <- ncol(calibrated_pvalues)
qvalues_list <- list()

cat("å¼€å§‹å¯¹", num_env_factors, "ä¸ªç¯å¢ƒå› å­è¿›è¡ŒFDRæ ¡æ­£...\n")

# åˆ›å»ºå®‰å…¨çš„qvalueè®¡ç®—å‡½æ•°
safe_qvalue <- function(pvals) {
  tryCatch({
    # å¤„ç†NAå€¼
    pvals_clean <- pvals
    pvals_clean[is.na(pvals_clean)] <- 1
    
    # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å€¼éƒ½ä¸º1
    if (all(pvals_clean == 1)) {
      return(rep(1, length(pvals_clean)))
    }
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å˜å¼‚
    if (length(unique(pvals_clean)) < 10) {
      cat("   æ³¨æ„ï¼špå€¼å˜å¼‚è¾ƒå°\n")
    }
    
    # è®¡ç®—qå€¼
    qobj <- qvalue(p = pvals_clean)
    return(qobj$qvalues)
  }, error = function(e) {
    cat("   qå€¼è®¡ç®—é”™è¯¯ï¼š", e$message, "\n")
    cat("   è¿”å›ä¿å®ˆå€¼ï¼ˆå…¨éƒ¨ä¸º1ï¼‰\n")
    return(rep(1, length(pvals)))
  })
}

for (i in 1:num_env_factors) {
  env_name <- colnames(calibrated_pvalues)[i]
  cat("  å¤„ç†ç¯å¢ƒå› å­", i, "/", num_env_factors, "ï¼š", env_name, "\n")
  
  pvals <- calibrated_pvalues[, i]
  
  # ä½¿ç”¨å®‰å…¨çš„qå€¼è®¡ç®—
  qvals <- safe_qvalue(pvals)
  
  # å­˜å‚¨ç»“æœ
  qvalues_list[[i]] <- data.frame(SVid = sv_ids, 
                                  pvalues = pvals, 
                                  qvalues = qvals)
  
  # ä¿å­˜æ¯ä¸ªç¯å¢ƒå› å­çš„qå€¼
  write.csv(qvalues_list[[i]], 
            file = paste0("qvalues_", env_name, "_corrected.csv"), 
            row.names = FALSE)
}

# åˆå¹¶æ‰€æœ‰qå€¼
all_qvalues_matrix <- do.call(cbind, lapply(qvalues_list, function(x) x$qvalues))
rownames(all_qvalues_matrix) <- sv_ids
colnames(all_qvalues_matrix) <- colnames(calibrated_pvalues)

write.csv(all_qvalues_matrix, file = "all_qvalues_SV_bio1_19_corrected.csv")
cat("\næ‰€æœ‰qå€¼å·²ä¿å­˜ä¸ºï¼šall_qvalues_SV_bio1_19_corrected.csv\n")

##############################################################################
# ç¬¬åæ­¥ï¼šç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬åæ­¥ï¼šç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

env_factor_names <- colnames(calibrated_pvalues)
threshold_list <- list()
significant_counts <- data.frame(Environment_Factor = env_factor_names, 
                                 Significant_SV_Count = integer(num_env_factors),
                                 stringsAsFactors = FALSE)

cat("å¼€å§‹ç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰...\n\n")

for (i in 1:num_env_factors) {
  env_name <- env_factor_names[i]
  cat("  ç­›é€‰ç¯å¢ƒå› å­ï¼š", env_name, "\n")
  
  # ä»qvalues_listè·å–qå€¼
  qvals <- qvalues_list[[i]]$qvalues
  
  # æ‰¾åˆ°FDRé˜ˆå€¼ä¸º0.05å¯¹åº”çš„på€¼é˜ˆå€¼
  if (any(qvals <= 0.05, na.rm = TRUE)) {
    valid_indices <- which(qvals <= 0.05)
    threshold_value_05 <- max(calibrated_pvalues[valid_indices, i], na.rm = TRUE)
    corresponding_qvalue_05 <- 0.05
  } else {
    threshold_value_05 <- NA
    corresponding_qvalue_05 <- NA
  }
  
  # æ‰¾åˆ°FDRé˜ˆå€¼ä¸º0.01å¯¹åº”çš„på€¼é˜ˆå€¼
  if (any(qvals <= 0.01, na.rm = TRUE)) {
    valid_indices <- which(qvals <= 0.01)
    threshold_value_01 <- max(calibrated_pvalues[valid_indices, i], na.rm = TRUE)
    corresponding_qvalue_01 <- 0.01
  } else {
    threshold_value_01 <- NA
    corresponding_qvalue_01 <- NA
  }
  
  # ä¿å­˜é˜ˆå€¼ä¿¡æ¯
  threshold_list[[i]] <- data.frame(
    Environment_Factor = env_name, 
    Threshold_05 = threshold_value_05, 
    FDR_qvalue_05 = corresponding_qvalue_05,
    Threshold_01 = threshold_value_01,
    FDR_qvalue_01 = corresponding_qvalue_01
  )
  
  # ç­›é€‰FDR < 0.05çš„æ˜¾è‘—æ€§SV
  significant_indices <- which(qvals < 0.05)
  
  if (length(significant_indices) > 0) {
    significant_sv_ids <- sv_ids[significant_indices]
    significant_pvals <- calibrated_pvalues[significant_indices, i]
    significant_qvals <- qvals[significant_indices]
    
    # ä¿å­˜æ˜¾è‘—æ€§ç»“æœ
    significant_results <- data.frame(
      SVid = significant_sv_ids, 
      pvalues = significant_pvals, 
      qvalues = significant_qvals
    )
    
    write.csv(significant_results, 
              file = paste0("significant_SVs_", env_name, "_FDR0.05_corrected.csv"), 
              row.names = FALSE)
    
    # å•ç‹¬ä¿å­˜æ˜¾è‘—æ€§SVæ ‡è¯†ç¬¦
    write.csv(data.frame(SVid = significant_sv_ids), 
              file = paste0("significant_SV_ids_", env_name, "_FDR0.05_corrected.csv"), 
              row.names = FALSE)
    
    significant_counts[i, "Significant_SV_Count"] <- length(significant_sv_ids)
    cat("    æ‰¾åˆ°", length(significant_sv_ids), "ä¸ªæ˜¾è‘—æ€§SV\n")
  } else {
    significant_counts[i, "Significant_SV_Count"] <- 0
    cat("    æœªæ‰¾åˆ°æ˜¾è‘—æ€§SV\n")
  }
}

# ä¿å­˜é˜ˆå€¼ä¿¡æ¯
threshold_df <- do.call(rbind, threshold_list)
write.csv(threshold_df, file = "FDR_thresholds_SV_bio1_19_corrected.csv", row.names = FALSE)
cat("\nFDRé˜ˆå€¼å·²ä¿å­˜ä¸ºï¼šFDR_thresholds_SV_bio1_19_corrected.csv\n")

# ä¿å­˜æ˜¾è‘—æ€§è®¡æ•°
write.csv(significant_counts, file = "significant_SV_counts_bio1_19_corrected.csv", row.names = FALSE)
cat("æ˜¾è‘—æ€§SVè®¡æ•°å·²ä¿å­˜ä¸ºï¼šsignificant_SV_counts_bio1_19_corrected.csv\n")

##############################################################################
# ç¬¬åä¸€æ­¥ï¼šç»Ÿè®¡æ‰€æœ‰æ˜¾è‘—æ€§SVï¼ˆå¹¶é›†ï¼‰
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬åä¸€æ­¥ï¼šç»Ÿè®¡æ‰€æœ‰æ˜¾è‘—æ€§SVï¼ˆå¹¶é›†ï¼‰\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

all_significant_sv_ids <- unique(unlist(lapply(1:num_env_factors, function(i) {
  qvals <- qvalues_list[[i]]$qvalues
  significant_indices <- which(qvals < 0.05)
  
  if (length(significant_indices) > 0) {
    return(sv_ids[significant_indices])
  }
  return(NULL)
})))

if (length(all_significant_sv_ids) > 0) {
  all_significant_sv_df <- data.frame(SVid = all_significant_sv_ids)
  significant_sv_count <- nrow(all_significant_sv_df)
  
  write.csv(all_significant_sv_df, 
            file = "all_significant_SV_ids_union_bio1_19_corrected.csv", 
            row.names = FALSE)
  
  cat("æ‰€æœ‰ç¯å¢ƒå› å­ä¸‹æ˜¾è‘—æ€§SVçš„æ•°é‡ï¼ˆå¹¶é›†ï¼‰ï¼š", significant_sv_count, "\n")
  cat("å SVæ€»æ•°çš„æ¯”ä¾‹ï¼š", round(significant_sv_count/length(sv_ids)*100, 2), "%\n")
  
  cat("\nå‰10ä¸ªæ˜¾è‘—æ€§SVæ ‡è¯†ç¬¦ï¼š\n")
  for (j in 1:min(10, length(all_significant_sv_ids))) {
    cat("  ", j, ". ", all_significant_sv_ids[j], "\n", sep = "")
  }
} else {
  cat("æœªæ‰¾åˆ°ä»»ä½•ç¯å¢ƒå› å­çš„æ˜¾è‘—æ€§SV\n")
}

##############################################################################
# ç¬¬åäºŒæ­¥ï¼šåˆ†ææ€»ç»“æŠ¥å‘Š
##############################################################################

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("ç¬¬åäºŒæ­¥ï¼šåˆ†ææ€»ç»“æŠ¥å‘Š\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

cat("ğŸ‰ LFMMåˆ†æå®Œæˆï¼ï¼ˆä½¿ç”¨.rawæ–‡ä»¶æå–çš„SVæ ‡è¯†ç¬¦ï¼‰\n\n")

cat("ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š\n")
cat("  æ ·æœ¬æ•°é‡ï¼š", nrow(X_env_scaled), "\n")
cat("  SVæ•°é‡ï¼š", length(sv_ids), "\n")
cat("  ç¯å¢ƒå› å­ï¼š", num_env_factors, "ä¸ªï¼ˆBIO1-BIO19ï¼‰\n")
cat("  Kå€¼ï¼š", K, "\n")
cat("  GIFå€¼ï¼š", round(pv$gif, 3), "\n\n")

cat("ğŸ“ˆ ç»“æœç»Ÿè®¡ï¼š\n")
if (exists("significant_sv_count")) {
  cat("  æ˜¾è‘—æ€§SVæ€»æ•°ï¼ˆFDR < 0.05ï¼‰ï¼š", significant_sv_count, "\n")
  cat("  æ˜¾è‘—æ€§SVæ¯”ä¾‹ï¼š", round(significant_sv_count/length(sv_ids)*100, 2), "%\n")
} else {
  cat("  æœªæ‰¾åˆ°æ˜¾è‘—æ€§SV\n")
}

cat("\nğŸ“‹ å„ç¯å¢ƒå› å­æ˜¾è‘—æ€§SVæ•°é‡ï¼š\n")
total_significant <- 0
for (i in 1:num_env_factors) {
  env_name <- env_factor_names[i]
  count <- significant_counts[i, "Significant_SV_Count"]
  total_significant <- total_significant + count
  cat(sprintf("  %-10s: %6d ä¸ªæ˜¾è‘—æ€§SV\n", env_name, count))
}

cat(sprintf("\n  åˆè®¡ï¼š%d ä¸ªæ˜¾è‘—æ€§å…³è”\n", total_significant))

cat("\nğŸ’¾ ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ–‡ä»¶ååŒ…å«'_corrected'ï¼‰ï¼š\n")
files <- list.files(pattern = "_corrected\\.(csv|rds)$")
if (length(files) > 0) {
  file_count <- 0
  for (file in files) {
    if (file.exists(file)) {
      file_size <- file.size(file)
      cat(sprintf("  %-50s %8.1f KB\n", file, file_size/1024))
      file_count <- file_count + 1
    }
  }
  cat("\n  å…±ç”Ÿæˆ", file_count, "ä¸ªæ–‡ä»¶\n")
} else {
  cat("  æš‚æ— æ–‡ä»¶\n")
}

cat("\n", paste(rep("=", 70), collapse = ""), "\n")
cat("åˆ†æå®Œæˆæ—¶é—´ï¼š", date(), "\n")
cat(paste(rep("=", 70), collapse = ""), "\n")

# ä¿å­˜å·¥ä½œç©ºé—´
save.image("LFMM_analysis_corrected.RData")
cat("\nå·¥ä½œç©ºé—´å·²ä¿å­˜ä¸ºï¼šLFMM_analysis_corrected.RData\n")
cat("æ‚¨å¯ä»¥ä½¿ç”¨ load('LFMM_analysis_corrected.RData') é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®\n")

cat("\nâœ¨ åˆ†ææµç¨‹å…¨éƒ¨å®Œæˆï¼è¯·æŸ¥çœ‹å·¥ä½œç›®å½•ä¸­çš„ç»“æœæ–‡ä»¶ã€‚\n")

# æœ€åï¼Œç‰¹åˆ«è®°å½•é‡å¤SVçš„å¤„ç†æƒ…å†µ
dup_info_file <- "duplicate_SV_processing_info.txt"
writeLines(c(
  "é‡å¤SVå¤„ç†ä¿¡æ¯ï¼š",
  paste("åˆ†ææ—¶é—´ï¼š", Sys.time()),
  paste("é‡å¤SVä½ç½®ï¼š", length(which(grepl("_dup", sv_ids)))),
  paste("åŸå§‹é‡å¤SVæ ‡è¯†ç¬¦ï¼š", ">10464698>10464724"),
  paste("å¤„ç†åçš„æ ‡è¯†ç¬¦ï¼š"),
  paste("  ", sv_ids[grepl(">10464698>10464724", sv_ids)])
), dup_info_file)

cat("\né‡å¤SVå¤„ç†ä¿¡æ¯å·²ä¿å­˜åˆ°ï¼š", dup_info_file, "\n")






ç»“æœ
 cat(sprintf("%-20s -> %-20s\n", 
+                 substr(sv_full_names[i], 1, 20), 
+                 substr(sv_ids[i], 1, 20)))
+   }
+   
+   # æ£€æŸ¥é‡å¤
+   dup_counts <- sum(duplicated(sv_ids))
+   if (dup_counts > 0) {
+     cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", dup_counts, "ä¸ªé‡å¤çš„SVæ ‡è¯†ç¬¦\n")
+     dup_ids <- sv_ids[duplicated(sv_ids)]
+     cat("é‡å¤çš„æ ‡è¯†ç¬¦ï¼ˆå‰5ä¸ªï¼‰ï¼š\n")
+     for (i in 1:min(5, length(dup_ids))) {
+       cat("  ", dup_ids[i], "\n")
+     }
+     
+     # ä½¿ç”¨make.uniqueå¤„ç†é‡å¤
+     sv_ids <- make.unique(sv_ids, sep = "_dup")
+     cat("å·²ä½¿ç”¨make.uniqueä¿®å¤é‡å¤æ ‡è¯†ç¬¦\n")
+     
+     # è®°å½•é‡å¤å¤„ç†æƒ…å†µ
+     dup_positions <- which(duplicated(sub("_[^_]+$", "", sv_full_names)))
+     if (length(dup_positions) > 0) {
+       cat("\né‡å¤SVçš„è¯¦ç»†ä¿¡æ¯ï¼š\n")
+       for (pos in dup_positions) {
+         original_name <- sv_full_names[pos]
+         processed_name <- sv_ids[pos]
+         cat(sprintf("  ä½ç½® %d: %s -> %s\n", 
+                     pos, 
+                     substr(original_name, 1, 50), 
+                     processed_name))
+       }
+     }
+   } else {
+     cat("\nâœ“ æ²¡æœ‰å‘ç°é‡å¤çš„SVæ ‡è¯†ç¬¦\n")
+   }
+   
+   # æ£€æŸ¥ç©ºå€¼æˆ–æ— æ•ˆå€¼
+   invalid_indices <- which(is.na(sv_ids) | sv_ids == "" | sv_ids == "NA")
+   if (length(invalid_indices) > 0) {
+     cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", length(invalid_indices), "ä¸ªæ— æ•ˆSVæ ‡è¯†ç¬¦\n")
+     
+     # ä¿®å¤æ— æ•ˆå€¼
+     for (i in invalid_indices) {
+       sv_ids[i] <- paste0("SV_", i)
+     }
+     cat("å·²ä¿®å¤æ— æ•ˆæ ‡è¯†ç¬¦\n")
+   }
+   
+   cat("\næœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š\n")
+   cat("  æ€»æ•°ï¼š", length(sv_ids), "\n")
+   
+   # éªŒè¯æå–æ˜¯å¦æˆåŠŸ
+   cat("\néªŒè¯æå–ç»“æœï¼š\n")
+   test_indices <- c(1, 10, 100, 1000, 10000)
+   test_indices <- test_indices[test_indices <= length(sv_ids)]
+   
+   for (i in seq_along(test_indices)) {
+     idx <- test_indices[i]
+     original <- sv_full_names[idx]
+     processed <- sv_ids[idx]
+     cat(sprintf("  %6d: %-25s -> %-25s\n", 
+                 idx, 
+                 substr(original, 1, 25), 
+                 processed))
+   }
+   
+ }, error = function(e) {
+   cat("SVæ ‡è¯†ç¬¦æå–å¤±è´¥ï¼š", e$message, "\n")
+   cat("å°è¯•å¤‡ç”¨æ–¹æ³•...\n")
+   
+   # å¤‡ç”¨æ–¹æ³•
+   raw_sample <- fread("200_samples_sv.plink.recodeA.raw", 
+                       nrows = 5, 
+                       header = TRUE)
+   
+   all_cols <- colnames(raw_sample)
+   sv_cols <- all_cols[7:length(all_cols)]
+   sv_ids <- sub("_[^_]+$", "", sv_cols)
+   sv_ids <- make.unique(sv_ids, sep = "_dup")  # ä»ç„¶ä½¿ç”¨make.unique
+   
+   cat("ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æå–åˆ°", length(sv_ids), "ä¸ªSVæ ‡è¯†ç¬¦\n")
+ })
è¡¨å¤´æ€»åˆ—æ•°ï¼š 55809 

è¡¨å¤´ç»“æ„ï¼ˆå‰15åˆ—ï¼‰ï¼š
    1. FID
    2. IID
    3. PAT
    4. MAT
    5. SEX
    6. PHENOTYPE
    7. >189>192_T
    8. >438>442_A
    9. >492>495_C
   10. >550>554_C
   11. >912>915_GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGA
   12. >1246>1250_A
   13. >1653>1656_ATATATATATATATATATATATATATATATATATATATATATATATATATAT
   14. >2155>2165_G
   15. >2347>2352_G

SVåŸå§‹åç§°æ•°é‡ï¼š 55803 
å¤„ç†åçš„SVæ ‡è¯†ç¬¦æ•°é‡ï¼š 55803 

SVæ ‡è¯†ç¬¦è½¬æ¢ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰ï¼š
åŸå§‹åç§° -> å¤„ç†åæ ‡è¯†ç¬¦
---------------------------------------- 
>189>192_T           -> >189>192            
>438>442_A           -> >438>442            
>492>495_C           -> >492>495            
>550>554_C           -> >550>554            
>912>915_GGGGGGGGGGG -> >912>915            
>1246>1250_A         -> >1246>1250          
>1653>1656_ATATATATA -> >1653>1656          
>2155>2165_G         -> >2155>2165          
>2347>2352_G         -> >2347>2352          
>2415>2420_A         -> >2415>2420          

âš ï¸ è­¦å‘Šï¼šå‘ç° 1 ä¸ªé‡å¤çš„SVæ ‡è¯†ç¬¦
é‡å¤çš„æ ‡è¯†ç¬¦ï¼ˆå‰5ä¸ªï¼‰ï¼š
   >10464698>10464724 
å·²ä½¿ç”¨make.uniqueä¿®å¤é‡å¤æ ‡è¯†ç¬¦

é‡å¤SVçš„è¯¦ç»†ä¿¡æ¯ï¼š
  ä½ç½® 24214: >10464698>10464724_TGTTGACCTCAAAAAGTGTATCTATGAGCTG -> >10464698>10464724_dup1

æœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š
  æ€»æ•°ï¼š 55803 

éªŒè¯æå–ç»“æœï¼š
       1: >189>192_T                -> >189>192                 
      10: >2415>2420_A              -> >2415>2420               
     100: >31926>31972_TTAAATGCTATT -> >31926>31972             
    1000: >312604>312609_CCAAAATTTT -> >312604>312609           
   10000: >4306914>4306919_G        -> >4306914>4306919         
> cat("\nSVæ ‡è¯†ç¬¦æå–å®Œæˆï¼\n")

SVæ ‡è¯†ç¬¦æå–å®Œæˆï¼
>   # æ£€æŸ¥ç©ºå€¼æˆ–æ— æ•ˆå€¼
>   invalid_indices <- which(is.na(sv_ids) | sv_ids == "" | sv_ids == "NA")
>   if (length(invalid_indices) > 0) {
+     cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", length(invalid_indices), "ä¸ªæ— æ•ˆSVæ ‡è¯†ç¬¦\n")
+     
+     # ä¿®å¤æ— æ•ˆå€¼
+     for (i in invalid_indices) {
+       sv_ids[i] <- paste0("SV_", i)
+     }
+     cat("å·²ä¿®å¤æ— æ•ˆæ ‡è¯†ç¬¦\n")
+   }
>   cat("\næœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š\n")

æœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š
>   cat("  æ€»æ•°ï¼š", length(sv_ids), "\n")
  æ€»æ•°ï¼š 55803 
>   # éªŒè¯æå–æ˜¯å¦æˆåŠŸ
>   cat("\néªŒè¯æå–ç»“æœï¼š\n")

éªŒè¯æå–ç»“æœï¼š
>   test_indices <- c(1, 10, 100, 1000, 10000)
>   test_indices <- test_indices[test_indices <= length(sv_ids)]
>   for (i in seq_along(test_indices)) {
+     idx <- test_indices[i]
+     original <- sv_full_names[idx]
+     processed <- sv_ids[idx]
+     cat(sprintf("  %6d: %-25s -> %-25s\n", 
+                 idx, 
+                 substr(original, 1, 25), 
+                 processed))
+   }
       1: >189>192_T                -> >189>192                 
      10: >2415>2420_A              -> >2415>2420               
     100: >31926>31972_TTAAATGCTATT -> >31926>31972             
    1000: >312604>312609_CCAAAATTTT -> >312604>312609           
   10000: >4306914>4306919_G        -> >4306914>4306919         
> # æ–¹æ³•ï¼šç›´æ¥è¯»å–ç¬¬ä¸€è¡Œå¹¶å¤„ç†SVåç§°
> tryCatch({
+   # è¯»å–.rawæ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼ˆè¡¨å¤´è¡Œï¼‰
+   first_line <- readLines("200_samples_sv.plink.recodeA.raw", n = 1)
+   
+   # åˆ†å‰²è¡¨å¤´ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰
+   header_parts <- strsplit(first_line, "\\s+")[[1]]
+   cat("è¡¨å¤´æ€»åˆ—æ•°ï¼š", length(header_parts), "\n")
+   
+   # æ˜¾ç¤ºè¡¨å¤´ç»“æ„
+   cat("\nè¡¨å¤´ç»“æ„ï¼ˆå‰15åˆ—ï¼‰ï¼š\n")
+   for (i in 1:min(15, length(header_parts))) {
+     cat(sprintf("  %3d. %s\n", i, header_parts[i]))
+   }
+   
+   # æå–SVæ ‡è¯†ç¬¦ï¼ˆä»ç¬¬7åˆ—å¼€å§‹ï¼‰
+   sv_full_names <- header_parts[7:length(header_parts)]
+   cat("\nSVåŸå§‹åç§°æ•°é‡ï¼š", length(sv_full_names), "\n")
+   
+   # å»é™¤æœ«å°¾çš„ç­‰ä½åŸºå› åç¼€
+   sv_ids <- sub("_[^_]+$", "", sv_full_names)
+   
+   cat("å¤„ç†åçš„SVæ ‡è¯†ç¬¦æ•°é‡ï¼š", length(sv_ids), "\n\n")
+   
+   # æ˜¾ç¤ºå‰åå¯¹æ¯”
+   cat("SVæ ‡è¯†ç¬¦è½¬æ¢ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰ï¼š\n")
+   cat("åŸå§‹åç§° -> å¤„ç†åæ ‡è¯†ç¬¦\n")
+   cat(paste(rep("-", 40), collapse = ""), "\n")
+   
+   for (i in 1:min(10, length(sv_ids))) {
+     cat(sprintf("%-20s -> %-20s\n", 
+                 substr(sv_full_names[i], 1, 20), 
+                 substr(sv_ids[i], 1, 20)))
+   }
+   
+   # æ£€æŸ¥é‡å¤
+   dup_counts <- sum(duplicated(sv_ids))
+   if (dup_counts > 0) {
+     cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", dup_counts, "ä¸ªé‡å¤çš„SVæ ‡è¯†ç¬¦\n")
+     dup_ids <- sv_ids[duplicated(sv_ids)]
+     cat("é‡å¤çš„æ ‡è¯†ç¬¦ï¼ˆå‰5ä¸ªï¼‰ï¼š\n")
+     for (i in 1:min(5, length(dup_ids))) {
+       cat("  ", dup_ids[i], "\n")
+     }
+     
+     # ä½¿ç”¨make.uniqueå¤„ç†é‡å¤
+     sv_ids <- make.unique(sv_ids, sep = "_dup")
+     cat("å·²ä½¿ç”¨make.uniqueä¿®å¤é‡å¤æ ‡è¯†ç¬¦\n")
+     
+     # è®°å½•é‡å¤å¤„ç†æƒ…å†µ
+     dup_positions <- which(duplicated(sub("_[^_]+$", "", sv_full_names)))
+     if (length(dup_positions) > 0) {
+       cat("\né‡å¤SVçš„è¯¦ç»†ä¿¡æ¯ï¼š\n")
+       for (pos in dup_positions) {
+         original_name <- sv_full_names[pos]
+         processed_name <- sv_ids[pos]
+         cat(sprintf("  ä½ç½® %d: %s -> %s\n", 
+                     pos, 
+                     substr(original_name, 1, 50), 
+                     processed_name))
+       }
+     }
+   } else {
+     cat("\nâœ“ æ²¡æœ‰å‘ç°é‡å¤çš„SVæ ‡è¯†ç¬¦\n")
+   }
+   
+   # æ£€æŸ¥ç©ºå€¼æˆ–æ— æ•ˆå€¼
+   invalid_indices <- which(is.na(sv_ids) | sv_ids == "" | sv_ids == "NA")
+   if (length(invalid_indices) > 0) {
+     cat("\nâš ï¸ è­¦å‘Šï¼šå‘ç°", length(invalid_indices), "ä¸ªæ— æ•ˆSVæ ‡è¯†ç¬¦\n")
+     
+     # ä¿®å¤æ— æ•ˆå€¼
+     for (i in invalid_indices) {
+       sv_ids[i] <- paste0("SV_", i)
+     }
+     cat("å·²ä¿®å¤æ— æ•ˆæ ‡è¯†ç¬¦\n")
+   }
+   
+   cat("\næœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š\n")
+   cat("  æ€»æ•°ï¼š", length(sv_ids), "\n")
+   
+   # éªŒè¯æå–æ˜¯å¦æˆåŠŸ
+   cat("\néªŒè¯æå–ç»“æœï¼š\n")
+   test_indices <- c(1, 10, 100, 1000, 10000)
+   test_indices <- test_indices[test_indices <= length(sv_ids)]
+   
+   for (i in seq_along(test_indices)) {
+     idx <- test_indices[i]
+     original <- sv_full_names[idx]
+     processed <- sv_ids[idx]
+     cat(sprintf("  %6d: %-25s -> %-25s\n", 
+                 idx, 
+                 substr(original, 1, 25), 
+                 processed))
+   }
+   
+ }, error = function(e) {
+   cat("SVæ ‡è¯†ç¬¦æå–å¤±è´¥ï¼š", e$message, "\n")
+   cat("å°è¯•å¤‡ç”¨æ–¹æ³•...\n")
+   
+   # å¤‡ç”¨æ–¹æ³•
+   raw_sample <- fread("200_samples_sv.plink.recodeA.raw", 
+                       nrows = 5, 
+                       header = TRUE)
+   
+   all_cols <- colnames(raw_sample)
+   sv_cols <- all_cols[7:length(all_cols)]
+   sv_ids <- sub("_[^_]+$", "", sv_cols)
+   sv_ids <- make.unique(sv_ids, sep = "_dup")  # ä»ç„¶ä½¿ç”¨make.unique
+   
+   cat("ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æå–åˆ°", length(sv_ids), "ä¸ªSVæ ‡è¯†ç¬¦\n")
+ })
è¡¨å¤´æ€»åˆ—æ•°ï¼š 55809 

è¡¨å¤´ç»“æ„ï¼ˆå‰15åˆ—ï¼‰ï¼š
    1. FID
    2. IID
    3. PAT
    4. MAT
    5. SEX
    6. PHENOTYPE
    7. >189>192_T
    8. >438>442_A
    9. >492>495_C
   10. >550>554_C
   11. >912>915_GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGA
   12. >1246>1250_A
   13. >1653>1656_ATATATATATATATATATATATATATATATATATATATATATATATATATAT
   14. >2155>2165_G
   15. >2347>2352_G

SVåŸå§‹åç§°æ•°é‡ï¼š 55803 
å¤„ç†åçš„SVæ ‡è¯†ç¬¦æ•°é‡ï¼š 55803 

SVæ ‡è¯†ç¬¦è½¬æ¢ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰ï¼š
åŸå§‹åç§° -> å¤„ç†åæ ‡è¯†ç¬¦
---------------------------------------- 
>189>192_T           -> >189>192            
>438>442_A           -> >438>442            
>492>495_C           -> >492>495            
>550>554_C           -> >550>554            
>912>915_GGGGGGGGGGG -> >912>915            
>1246>1250_A         -> >1246>1250          
>1653>1656_ATATATATA -> >1653>1656          
>2155>2165_G         -> >2155>2165          
>2347>2352_G         -> >2347>2352          
>2415>2420_A         -> >2415>2420          

âš ï¸ è­¦å‘Šï¼šå‘ç° 1 ä¸ªé‡å¤çš„SVæ ‡è¯†ç¬¦
é‡å¤çš„æ ‡è¯†ç¬¦ï¼ˆå‰5ä¸ªï¼‰ï¼š
   >10464698>10464724 
å·²ä½¿ç”¨make.uniqueä¿®å¤é‡å¤æ ‡è¯†ç¬¦

é‡å¤SVçš„è¯¦ç»†ä¿¡æ¯ï¼š
  ä½ç½® 24214: >10464698>10464724_TGTTGACCTCAAAAAGTGTATCTATGAGCTG -> >10464698>10464724_dup1

æœ€ç»ˆSVæ ‡è¯†ç¬¦ç»Ÿè®¡ï¼š
  æ€»æ•°ï¼š 55803 

éªŒè¯æå–ç»“æœï¼š
       1: >189>192_T                -> >189>192                 
      10: >2415>2420_A              -> >2415>2420               
     100: >31926>31972_TTAAATGCTATT -> >31926>31972             
    1000: >312604>312609_CCAAAATTTT -> >312604>312609           
   10000: >4306914>4306919_G        -> >4306914>4306919         
> cat("\nSVæ ‡è¯†ç¬¦æå–å®Œæˆï¼\n")

SVæ ‡è¯†ç¬¦æå–å®Œæˆï¼
> cat("SVæ•°é‡ï¼š", length(sv_ids), "\n")
SVæ•°é‡ï¼š 55803 
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬äºŒæ­¥ï¼šè¯»å–ç¯å¢ƒå› å­æ•°æ®\n")
ç¬¬äºŒæ­¥ï¼šè¯»å–ç¯å¢ƒå› å­æ•°æ®
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("æ­£åœ¨è¯»å–ç¯å¢ƒå› å­æ•°æ®...\n")
æ­£åœ¨è¯»å–ç¯å¢ƒå› å­æ•°æ®...
> X <- read.csv("Climate_current_200samples.csv", header = TRUE, row.names = 1)
> # æå–BIO1-BIO19
> X_env <- X[, 3:21]
> cat("ç¯å¢ƒæ•°æ®ç»´åº¦ï¼š", dim(X_env), "\n")
ç¯å¢ƒæ•°æ®ç»´åº¦ï¼š 200 19 
> cat("ç¯å¢ƒå› å­åç§°ï¼š", paste(colnames(X_env), collapse = ", "), "\n")
ç¯å¢ƒå› å­åç§°ï¼š BIO1, BIO2, BIO3, BIO4, BIO5, BIO6, BIO7, BIO8, BIO9, BIO10, BIO11, BIO12, BIO13, BIO14, BIO15, BIO16, BIO17, BIO18, BIO19 
> # æ ‡å‡†åŒ–ç¯å¢ƒæ•°æ®
> cat("\næ ‡å‡†åŒ–ç¯å¢ƒæ•°æ®...\n")

æ ‡å‡†åŒ–ç¯å¢ƒæ•°æ®...
> X_env_scaled <- as.data.frame(scale(X_env))
> cat("æ ‡å‡†åŒ–å®Œæˆ\n")
æ ‡å‡†åŒ–å®Œæˆ
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬ä¸‰æ­¥ï¼šè¯»å–åŸºå› å‹æ•°æ®\n")
ç¬¬ä¸‰æ­¥ï¼šè¯»å–åŸºå› å‹æ•°æ®
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("æ­£åœ¨è¯»å–åŸºå› å‹æ•°æ®ï¼ˆ.lfmmæ ¼å¼ï¼‰...\n")
æ­£åœ¨è¯»å–åŸºå› å‹æ•°æ®ï¼ˆ.lfmmæ ¼å¼ï¼‰...
> Y <- fread("200_samples_sv.plink.recodeA.lfmm", header = FALSE)
> Y_matrix <- as.matrix(Y)
> cat("åŸºå› å‹æ•°æ®ç»´åº¦ï¼š", dim(Y_matrix), "\n")
åŸºå› å‹æ•°æ®ç»´åº¦ï¼š 200 55803 
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥\n")
ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> # æ£€æŸ¥SVæ•°é‡æ˜¯å¦åŒ¹é…
> if (ncol(Y_matrix) != length(sv_ids)) {
+   cat("âš ï¸ è­¦å‘Šï¼šSVæ ‡è¯†ç¬¦æ•°é‡ï¼ˆ", length(sv_ids), 
+       "ï¼‰ä¸åŸºå› å‹æ•°æ®SVæ•°é‡ï¼ˆ", ncol(Y_matrix), "ï¼‰ä¸åŒ¹é…\n")
+   
+   min_count <- min(length(sv_ids), ncol(Y_matrix))
+   sv_ids <- sv_ids[1:min_count]
+   Y_matrix <- Y_matrix[, 1:min_count]
+   
+   cat("å·²è°ƒæ•´ä¸º", min_count, "ä¸ªSV\n")
+ } else {
+   cat("âœ“ SVæ•°é‡åŒ¹é…ï¼š", length(sv_ids), "ä¸ªSV\n")
+ }
âœ“ SVæ•°é‡åŒ¹é…ï¼š 55803 ä¸ªSV
> # æ£€æŸ¥æ ·æœ¬æ•°æ˜¯å¦åŒ¹é…
> if (nrow(X_env_scaled) != nrow(Y_matrix)) {
+   cat("\nâŒ é”™è¯¯ï¼šæ ·æœ¬æ•°ä¸åŒ¹é…ï¼\n")
+   cat("  ç¯å¢ƒæ•°æ®æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
+   cat("  åŸºå› å‹æ•°æ®æ ·æœ¬æ•°ï¼š", nrow(Y_matrix), "\n")
+   stop("è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼Œç¡®ä¿æ ·æœ¬é¡ºåºä¸€è‡´")
+ } else {
+   cat("âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š", nrow(X_env_scaled), "ä¸ªæ ·æœ¬\n")
+ }
âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š 200 ä¸ªæ ·æœ¬
> cat("\næ•°æ®ç»´åº¦ï¼š\n")

æ•°æ®ç»´åº¦ï¼š
> cat("  Xï¼ˆç¯å¢ƒï¼‰ï¼š", dim(X_env_scaled), "\n")
  Xï¼ˆç¯å¢ƒï¼‰ï¼š 200 19 
> cat("  Yï¼ˆåŸºå› å‹ï¼‰ï¼š", dim(Y_matrix), "\n")
  Yï¼ˆåŸºå› å‹ï¼‰ï¼š 200 55803 
> # ä¿å­˜SVæ ‡è¯†ç¬¦ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
> saveRDS(sv_ids, file = "sv_ids_processed.rds")
> cat("\nSVæ ‡è¯†ç¬¦å·²ä¿å­˜ä¸ºï¼šsv_ids_processed.rds\n")

SVæ ‡è¯†ç¬¦å·²ä¿å­˜ä¸ºï¼šsv_ids_processed.rds
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("SVæ ‡è¯†ç¬¦æå–å®Œæˆï¼Œå‡†å¤‡è¿›è¡ŒLFMMåˆ†æ\n")
SVæ ‡è¯†ç¬¦æå–å®Œæˆï¼Œå‡†å¤‡è¿›è¡ŒLFMMåˆ†æ
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥\n")
ç¬¬å››æ­¥ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> # æ£€æŸ¥SVæ•°é‡æ˜¯å¦åŒ¹é…
> if (ncol(Y_matrix) != length(sv_ids)) {
+   cat("âš ï¸ è­¦å‘Šï¼šSVæ ‡è¯†ç¬¦æ•°é‡ï¼ˆ", length(sv_ids), 
+       "ï¼‰ä¸åŸºå› å‹æ•°æ®SVæ•°é‡ï¼ˆ", ncol(Y_matrix), "ï¼‰ä¸åŒ¹é…\n")
+   
+   min_count <- min(length(sv_ids), ncol(Y_matrix))
+   sv_ids <- sv_ids[1:min_count]
+   Y_matrix <- Y_matrix[, 1:min_count]
+   
+   cat("å·²è°ƒæ•´ä¸º", min_count, "ä¸ªSV\n")
+ } else {
+   cat("âœ“ SVæ•°é‡åŒ¹é…ï¼š", length(sv_ids), "ä¸ªSV\n")
+ }
âœ“ SVæ•°é‡åŒ¹é…ï¼š 55803 ä¸ªSV
> # æ£€æŸ¥æ ·æœ¬æ•°æ˜¯å¦åŒ¹é…
> if (nrow(X_env_scaled) != nrow(Y_matrix)) {
+   cat("\nâŒ é”™è¯¯ï¼šæ ·æœ¬æ•°ä¸åŒ¹é…ï¼\n")
+   cat("  ç¯å¢ƒæ•°æ®æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
+   cat("  åŸºå› å‹æ•°æ®æ ·æœ¬æ•°ï¼š", nrow(Y_matrix), "\n")
+   stop("è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼Œç¡®ä¿æ ·æœ¬é¡ºåºä¸€è‡´")
+ } else {
+   cat("âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š", nrow(X_env_scaled), "ä¸ªæ ·æœ¬\n")
+ }
âœ“ æ ·æœ¬æ•°åŒ¹é…ï¼š 200 ä¸ªæ ·æœ¬
> cat("\næ•°æ®ç»´åº¦ï¼š\n")

æ•°æ®ç»´åº¦ï¼š
> cat("  Xï¼ˆç¯å¢ƒï¼‰ï¼š", dim(X_env_scaled), "\n")
  Xï¼ˆç¯å¢ƒï¼‰ï¼š 200 19 
> cat("  Yï¼ˆåŸºå› å‹ï¼‰ï¼š", dim(Y_matrix), "\n")
  Yï¼ˆåŸºå› å‹ï¼‰ï¼š 200 55803 
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬äº”æ­¥ï¼šè®¾ç½®åˆ†æå‚æ•°\n")
ç¬¬äº”æ­¥ï¼šè®¾ç½®åˆ†æå‚æ•°
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> # è®¾ç½®Kå€¼ï¼ˆæ½œåœ¨å› å­æ•°é‡ï¼‰
> # æ³¨æ„ï¼šæ‚¨éœ€è¦æ ¹æ®ç¾¤ä½“ç»“æ„åˆ†æç¡®å®šæœ€ä½³Kå€¼
> K <- 6  # è¿™é‡Œè®¾ä¸º6ï¼Œæ‚¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
> cat("Kå€¼ï¼ˆæ½œåœ¨å› å­æ•°é‡ï¼‰ï¼š", K, "\n")
Kå€¼ï¼ˆæ½œåœ¨å› å­æ•°é‡ï¼‰ï¼š 6 
> cat("æç¤ºï¼šKå€¼çš„é€‰æ‹©å¯¹ç»“æœå¾ˆé‡è¦ï¼Œå»ºè®®æ ¹æ®ç¾¤ä½“ç»“æ„åˆ†æç¡®å®š\n")
æç¤ºï¼šKå€¼çš„é€‰æ‹©å¯¹ç»“æœå¾ˆé‡è¦ï¼Œå»ºè®®æ ¹æ®ç¾¤ä½“ç»“æ„åˆ†æç¡®å®š
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬å…­æ­¥ï¼šLFMMæ¨¡å‹æ‹Ÿåˆ\n")
ç¬¬å…­æ­¥ï¼šLFMMæ¨¡å‹æ‹Ÿåˆ
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("å¼€å§‹LFMMæ¨¡å‹æ‹Ÿåˆ...\n")
å¼€å§‹LFMMæ¨¡å‹æ‹Ÿåˆ...
> cat("åˆ†æå‚æ•°ï¼š\n")
åˆ†æå‚æ•°ï¼š
> cat("  æ ·æœ¬æ•°ï¼š", nrow(X_env_scaled), "\n")
  æ ·æœ¬æ•°ï¼š 200 
> cat("  SVæ•°é‡ï¼š", ncol(Y_matrix), "\n")
  SVæ•°é‡ï¼š 55803 
> cat("  ç¯å¢ƒå› å­æ•°ï¼š", ncol(X_env_scaled), "\n")
  ç¯å¢ƒå› å­æ•°ï¼š 19 
> cat("  Kå€¼ï¼š", K, "\n")
  Kå€¼ï¼š 6 
> start_time <- Sys.time()
> cat("å¼€å§‹æ—¶é—´ï¼š", format(start_time, "%H:%M:%S"), "\n")
å¼€å§‹æ—¶é—´ï¼š 16:18:27 
> # è¿è¡ŒLFMMæ¨¡å‹
> mod.lfmm <- lfmm::lfmm_ridge(Y = Y_matrix,
+                              X = as.matrix(X_env_scaled),
+                              K = K)
> end_time <- Sys.time()
> cat("LFMMæ¨¡å‹æ‹Ÿåˆå®Œæˆï¼Œè€—æ—¶ï¼š", round(end_time - start_time, 2), "ç§’\n")
LFMMæ¨¡å‹æ‹Ÿåˆå®Œæˆï¼Œè€—æ—¶ï¼š 8.65 ç§’
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬ä¸ƒæ­¥ï¼šè®¡ç®—på€¼ï¼ˆä½¿ç”¨GIFæ ¡æ­£ï¼‰\n")
ç¬¬ä¸ƒæ­¥ï¼šè®¡ç®—på€¼ï¼ˆä½¿ç”¨GIFæ ¡æ­£ï¼‰
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("æ­£åœ¨è®¡ç®—på€¼...\n")
æ­£åœ¨è®¡ç®—på€¼...
> start_time <- Sys.time()
> pv <- lfmm::lfmm_test(Y = Y_matrix, 
+                       X = as.matrix(X_env_scaled), 
+                       lfmm = mod.lfmm,
+                       calibrate = "gif")
> end_time <- Sys.time()
> cat("på€¼è®¡ç®—å®Œæˆï¼Œè€—æ—¶ï¼š", round(end_time - start_time, 2), "ç§’\n")
på€¼è®¡ç®—å®Œæˆï¼Œè€—æ—¶ï¼š 13.27 ç§’
> # ä¿å­˜ç»“æœ
> saveRDS(pv, file = "pv_results_200samples_SV_bio1_19_corrected.rds")
> cat("ç»“æœå·²ä¿å­˜ä¸ºï¼špv_results_200samples_SV_bio1_19_corrected.rds\n")
ç»“æœå·²ä¿å­˜ä¸ºï¼špv_results_200samples_SV_bio1_19_corrected.rds
> # åŠ è½½ç»“æœ
> pv <- readRDS("pv_results_200samples_SV_bio1_19_corrected.rds")
> cat("åŸºå› ç»„è†¨èƒ€å› å­ï¼ˆGIFï¼‰ï¼š", round(pv$gif, 3), "\n")
åŸºå› ç»„è†¨èƒ€å› å­ï¼ˆGIFï¼‰ï¼š 1.871 2.005 2.277 1.92 0 0 0 1.764 1.569 2 1.676 2.261 1.997 2.005 1.957 2.087 1.821 2.421 2.289 
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬å…«æ­¥ï¼šæå–å’Œä¿å­˜på€¼\n")
ç¬¬å…«æ­¥ï¼šæå–å’Œä¿å­˜på€¼
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> raw_pvalues <- pv$pvalue
> calibrated_pvalues <- pv$calibrated.pvalue
> cat("åŸå§‹på€¼çŸ©é˜µç»´åº¦ï¼š", dim(raw_pvalues), "\n")
åŸå§‹på€¼çŸ©é˜µç»´åº¦ï¼š 55803 19 
> cat("æ ¡æ­£på€¼çŸ©é˜µç»´åº¦ï¼š", dim(calibrated_pvalues), "\n")
æ ¡æ­£på€¼çŸ©é˜µç»´åº¦ï¼š 55803 19 
> # è®¾ç½®è¡Œåˆ—å - å…³é”®æ­¥éª¤ï¼šä½¿ç”¨å¤„ç†åçš„sv_ids
> rownames(raw_pvalues) <- sv_ids
> rownames(calibrated_pvalues) <- sv_ids
> colnames(raw_pvalues) <- colnames(X_env_scaled)
> colnames(calibrated_pvalues) <- colnames(X_env_scaled)
> # ä¿å­˜åŸå§‹på€¼
> write.csv(raw_pvalues, file = "SV_raw_pvalues_bio1_19_corrected.csv")
> cat("åŸå§‹på€¼å·²ä¿å­˜ä¸ºï¼šSV_raw_pvalues_bio1_19_corrected.csv\n")
åŸå§‹på€¼å·²ä¿å­˜ä¸ºï¼šSV_raw_pvalues_bio1_19_corrected.csv
> # ä¿å­˜æ ¡æ­£på€¼
> write.csv(calibrated_pvalues, file = "SV_calibrated_pvalues_bio1_19_corrected.csv")
> cat("æ ¡æ­£på€¼å·²ä¿å­˜ä¸ºï¼šSV_calibrated_pvalues_bio1_19_corrected.csv\n")
æ ¡æ­£på€¼å·²ä¿å­˜ä¸ºï¼šSV_calibrated_pvalues_bio1_19_corrected.csv
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬ä¹æ­¥ï¼šFDRæ ¡æ­£ï¼ˆè®¡ç®—qå€¼ï¼‰\n")
ç¬¬ä¹æ­¥ï¼šFDRæ ¡æ­£ï¼ˆè®¡ç®—qå€¼ï¼‰
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> num_env_factors <- ncol(calibrated_pvalues)
> qvalues_list <- list()
> cat("å¼€å§‹å¯¹", num_env_factors, "ä¸ªç¯å¢ƒå› å­è¿›è¡ŒFDRæ ¡æ­£...\n")
å¼€å§‹å¯¹ 19 ä¸ªç¯å¢ƒå› å­è¿›è¡ŒFDRæ ¡æ­£...
> # åˆ›å»ºå®‰å…¨çš„qvalueè®¡ç®—å‡½æ•°
> safe_qvalue <- function(pvals) {
+   tryCatch({
+     # å¤„ç†NAå€¼
+     pvals_clean <- pvals
+     pvals_clean[is.na(pvals_clean)] <- 1
+     
+     # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å€¼éƒ½ä¸º1
+     if (all(pvals_clean == 1)) {
+       return(rep(1, length(pvals_clean)))
+     }
+     
+     # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å˜å¼‚
+     if (length(unique(pvals_clean)) < 10) {
+       cat("   æ³¨æ„ï¼špå€¼å˜å¼‚è¾ƒå°\n")
+     }
+     
+     # è®¡ç®—qå€¼
+     qobj <- qvalue(p = pvals_clean)
+     return(qobj$qvalues)
+   }, error = function(e) {
+     cat("   qå€¼è®¡ç®—é”™è¯¯ï¼š", e$message, "\n")
+     cat("   è¿”å›ä¿å®ˆå€¼ï¼ˆå…¨éƒ¨ä¸º1ï¼‰\n")
+     return(rep(1, length(pvals)))
+   })
+ }
> for (i in 1:num_env_factors) {
+   env_name <- colnames(calibrated_pvalues)[i]
+   cat("  å¤„ç†ç¯å¢ƒå› å­", i, "/", num_env_factors, "ï¼š", env_name, "\n")
+   
+   pvals <- calibrated_pvalues[, i]
+   
+   # ä½¿ç”¨å®‰å…¨çš„qå€¼è®¡ç®—
+   qvals <- safe_qvalue(pvals)
+   
+   # å­˜å‚¨ç»“æœ
+   qvalues_list[[i]] <- data.frame(SVid = sv_ids, 
+                                   pvalues = pvals, 
+                                   qvalues = qvals)
+   
+   # ä¿å­˜æ¯ä¸ªç¯å¢ƒå› å­çš„qå€¼
+   write.csv(qvalues_list[[i]], 
+             file = paste0("qvalues_", env_name, "_corrected.csv"), 
+             row.names = FALSE)
+ }
  å¤„ç†ç¯å¢ƒå› å­ 1 / 19 ï¼š BIO1 
  å¤„ç†ç¯å¢ƒå› å­ 2 / 19 ï¼š BIO2 
  å¤„ç†ç¯å¢ƒå› å­ 3 / 19 ï¼š BIO3 
  å¤„ç†ç¯å¢ƒå› å­ 4 / 19 ï¼š BIO4 
  å¤„ç†ç¯å¢ƒå› å­ 5 / 19 ï¼š BIO5 
  å¤„ç†ç¯å¢ƒå› å­ 6 / 19 ï¼š BIO6 
  å¤„ç†ç¯å¢ƒå› å­ 7 / 19 ï¼š BIO7 
  å¤„ç†ç¯å¢ƒå› å­ 8 / 19 ï¼š BIO8 
  å¤„ç†ç¯å¢ƒå› å­ 9 / 19 ï¼š BIO9 
  å¤„ç†ç¯å¢ƒå› å­ 10 / 19 ï¼š BIO10 
  å¤„ç†ç¯å¢ƒå› å­ 11 / 19 ï¼š BIO11 
  å¤„ç†ç¯å¢ƒå› å­ 12 / 19 ï¼š BIO12 
  å¤„ç†ç¯å¢ƒå› å­ 13 / 19 ï¼š BIO13 
  å¤„ç†ç¯å¢ƒå› å­ 14 / 19 ï¼š BIO14 
  å¤„ç†ç¯å¢ƒå› å­ 15 / 19 ï¼š BIO15 
  å¤„ç†ç¯å¢ƒå› å­ 16 / 19 ï¼š BIO16 
  å¤„ç†ç¯å¢ƒå› å­ 17 / 19 ï¼š BIO17 
  å¤„ç†ç¯å¢ƒå› å­ 18 / 19 ï¼š BIO18 
  å¤„ç†ç¯å¢ƒå› å­ 19 / 19 ï¼š BIO19 
> # åˆå¹¶æ‰€æœ‰qå€¼
> all_qvalues_matrix <- do.call(cbind, lapply(qvalues_list, function(x) x$qvalues))
> rownames(all_qvalues_matrix) <- sv_ids
> colnames(all_qvalues_matrix) <- colnames(calibrated_pvalues)
> write.csv(all_qvalues_matrix, file = "all_qvalues_SV_bio1_19_corrected.csv")
> cat("\næ‰€æœ‰qå€¼å·²ä¿å­˜ä¸ºï¼šall_qvalues_SV_bio1_19_corrected.csv\n")

æ‰€æœ‰qå€¼å·²ä¿å­˜ä¸ºï¼šall_qvalues_SV_bio1_19_corrected.csv
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬åæ­¥ï¼šç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰\n")
ç¬¬åæ­¥ï¼šç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> env_factor_names <- colnames(calibrated_pvalues)
> threshold_list <- list()
> significant_counts <- data.frame(Environment_Factor = env_factor_names, 
+                                  Significant_SV_Count = integer(num_env_factors),
+                                  stringsAsFactors = FALSE)
> cat("å¼€å§‹ç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰...\n\n")
å¼€å§‹ç­›é€‰æ˜¾è‘—æ€§SVï¼ˆFDR < 0.05ï¼‰...

> for (i in 1:num_env_factors) {
+   env_name <- env_factor_names[i]
+   cat("  ç­›é€‰ç¯å¢ƒå› å­ï¼š", env_name, "\n")
+   
+   # ä»qvalues_listè·å–qå€¼
+   qvals <- qvalues_list[[i]]$qvalues
+   
+   # æ‰¾åˆ°FDRé˜ˆå€¼ä¸º0.05å¯¹åº”çš„på€¼é˜ˆå€¼
+   if (any(qvals <= 0.05, na.rm = TRUE)) {
+     valid_indices <- which(qvals <= 0.05)
+     threshold_value_05 <- max(calibrated_pvalues[valid_indices, i], na.rm = TRUE)
+     corresponding_qvalue_05 <- 0.05
+   } else {
+     threshold_value_05 <- NA
+     corresponding_qvalue_05 <- NA
+   }
+   
+   # æ‰¾åˆ°FDRé˜ˆå€¼ä¸º0.01å¯¹åº”çš„på€¼é˜ˆå€¼
+   if (any(qvals <= 0.01, na.rm = TRUE)) {
+     valid_indices <- which(qvals <= 0.01)
+     threshold_value_01 <- max(calibrated_pvalues[valid_indices, i], na.rm = TRUE)
+     corresponding_qvalue_01 <- 0.01
+   } else {
+     threshold_value_01 <- NA
+     corresponding_qvalue_01 <- NA
+   }
+   
+   # ä¿å­˜é˜ˆå€¼ä¿¡æ¯
+   threshold_list[[i]] <- data.frame(
+     Environment_Factor = env_name, 
+     Threshold_05 = threshold_value_05, 
+     FDR_qvalue_05 = corresponding_qvalue_05,
+     Threshold_01 = threshold_value_01,
+     FDR_qvalue_01 = corresponding_qvalue_01
+   )
+   
+   # ç­›é€‰FDR < 0.05çš„æ˜¾è‘—æ€§SV
+   significant_indices <- which(qvals < 0.05)
+   
+   if (length(significant_indices) > 0) {
+     significant_sv_ids <- sv_ids[significant_indices]
+     significant_pvals <- calibrated_pvalues[significant_indices, i]
+     significant_qvals <- qvals[significant_indices]
+     
+     # ä¿å­˜æ˜¾è‘—æ€§ç»“æœ
+     significant_results <- data.frame(
+       SVid = significant_sv_ids, 
+       pvalues = significant_pvals, 
+       qvalues = significant_qvals
+     )
+     
+     write.csv(significant_results, 
+               file = paste0("significant_SVs_", env_name, "_FDR0.05_corrected.csv"), 
+               row.names = FALSE)
+     
+     # å•ç‹¬ä¿å­˜æ˜¾è‘—æ€§SVæ ‡è¯†ç¬¦
+     write.csv(data.frame(SVid = significant_sv_ids), 
+               file = paste0("significant_SV_ids_", env_name, "_FDR0.05_corrected.csv"), 
+               row.names = FALSE)
+     
+     significant_counts[i, "Significant_SV_Count"] <- length(significant_sv_ids)
+     cat("    æ‰¾åˆ°", length(significant_sv_ids), "ä¸ªæ˜¾è‘—æ€§SV\n")
+   } else {
+     significant_counts[i, "Significant_SV_Count"] <- 0
+     cat("    æœªæ‰¾åˆ°æ˜¾è‘—æ€§SV\n")
+   }
+ }
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO1 
    æ‰¾åˆ° 57 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO2 
    æ‰¾åˆ° 109 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO3 
    æ‰¾åˆ° 282 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO4 
    æ‰¾åˆ° 6 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO5 
    æ‰¾åˆ° 43 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO6 
    æ‰¾åˆ° 46 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO7 
    æ‰¾åˆ° 39 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO8 
    æ‰¾åˆ° 15 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO9 
    æ‰¾åˆ° 176 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO10 
    æ‰¾åˆ° 51 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO11 
    æ‰¾åˆ° 5 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO12 
    æ‰¾åˆ° 97 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO13 
    æ‰¾åˆ° 100 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO14 
    æ‰¾åˆ° 43 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO15 
    æ‰¾åˆ° 160 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO16 
    æ‰¾åˆ° 206 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO17 
    æœªæ‰¾åˆ°æ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO18 
    æ‰¾åˆ° 182 ä¸ªæ˜¾è‘—æ€§SV
  ç­›é€‰ç¯å¢ƒå› å­ï¼š BIO19 
    æ‰¾åˆ° 261 ä¸ªæ˜¾è‘—æ€§SV
> # ä¿å­˜é˜ˆå€¼ä¿¡æ¯
> threshold_df <- do.call(rbind, threshold_list)
> write.csv(threshold_df, file = "FDR_thresholds_SV_bio1_19_corrected.csv", row.names = FALSE)
> cat("\nFDRé˜ˆå€¼å·²ä¿å­˜ä¸ºï¼šFDR_thresholds_SV_bio1_19_corrected.csv\n")

FDRé˜ˆå€¼å·²ä¿å­˜ä¸ºï¼šFDR_thresholds_SV_bio1_19_corrected.csv
> # ä¿å­˜æ˜¾è‘—æ€§è®¡æ•°
> write.csv(significant_counts, file = "significant_SV_counts_bio1_19_corrected.csv", row.names = FALSE)
> cat("æ˜¾è‘—æ€§SVè®¡æ•°å·²ä¿å­˜ä¸ºï¼šsignificant_SV_counts_bio1_19_corrected.csv\n")
æ˜¾è‘—æ€§SVè®¡æ•°å·²ä¿å­˜ä¸ºï¼šsignificant_SV_counts_bio1_19_corrected.csv
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬åä¸€æ­¥ï¼šç»Ÿè®¡æ‰€æœ‰æ˜¾è‘—æ€§SVï¼ˆå¹¶é›†ï¼‰\n")
ç¬¬åä¸€æ­¥ï¼šç»Ÿè®¡æ‰€æœ‰æ˜¾è‘—æ€§SVï¼ˆå¹¶é›†ï¼‰
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> all_significant_sv_ids <- unique(unlist(lapply(1:num_env_factors, function(i) {
+   qvals <- qvalues_list[[i]]$qvalues
+   significant_indices <- which(qvals < 0.05)
+   
+   if (length(significant_indices) > 0) {
+     return(sv_ids[significant_indices])
+   }
+   return(NULL)
+ })))
> if (length(all_significant_sv_ids) > 0) {
+   all_significant_sv_df <- data.frame(SVid = all_significant_sv_ids)
+   significant_sv_count <- nrow(all_significant_sv_df)
+   
+   write.csv(all_significant_sv_df, 
+             file = "all_significant_SV_ids_union_bio1_19_corrected.csv", 
+             row.names = FALSE)
+   
+   cat("æ‰€æœ‰ç¯å¢ƒå› å­ä¸‹æ˜¾è‘—æ€§SVçš„æ•°é‡ï¼ˆå¹¶é›†ï¼‰ï¼š", significant_sv_count, "\n")
+   cat("å SVæ€»æ•°çš„æ¯”ä¾‹ï¼š", round(significant_sv_count/length(sv_ids)*100, 2), "%\n")
+   
+   cat("\nå‰10ä¸ªæ˜¾è‘—æ€§SVæ ‡è¯†ç¬¦ï¼š\n")
+   for (j in 1:min(10, length(all_significant_sv_ids))) {
+     cat("  ", j, ". ", all_significant_sv_ids[j], "\n", sep = "")
+   }
+ } else {
+   cat("æœªæ‰¾åˆ°ä»»ä½•ç¯å¢ƒå› å­çš„æ˜¾è‘—æ€§SV\n")
+ }
æ‰€æœ‰ç¯å¢ƒå› å­ä¸‹æ˜¾è‘—æ€§SVçš„æ•°é‡ï¼ˆå¹¶é›†ï¼‰ï¼š 1078 
å SVæ€»æ•°çš„æ¯”ä¾‹ï¼š 1.93 %

å‰10ä¸ªæ˜¾è‘—æ€§SVæ ‡è¯†ç¬¦ï¼š
  1. >2701106>2701109
  2. >2810513>2810517
  3. >2968548>2968627
  4. >2968906>2968910
  5. >2971770>2971779
  6. >3022521>3022538
  7. >3069995>3070001
  8. >3081063>3081066
  9. >4317640>4317644
  10. >4414977>4414986
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("ç¬¬åäºŒæ­¥ï¼šåˆ†ææ€»ç»“æŠ¥å‘Š\n")
ç¬¬åäºŒæ­¥ï¼šåˆ†ææ€»ç»“æŠ¥å‘Š
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> cat("ğŸ‰ LFMMåˆ†æå®Œæˆï¼ï¼ˆä½¿ç”¨.rawæ–‡ä»¶æå–çš„SVæ ‡è¯†ç¬¦ï¼‰\n\n")
ğŸ‰ LFMMåˆ†æå®Œæˆï¼ï¼ˆä½¿ç”¨.rawæ–‡ä»¶æå–çš„SVæ ‡è¯†ç¬¦ï¼‰

> cat("ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š\n")
ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š
> cat("  æ ·æœ¬æ•°é‡ï¼š", nrow(X_env_scaled), "\n")
  æ ·æœ¬æ•°é‡ï¼š 200 
> cat("  SVæ•°é‡ï¼š", length(sv_ids), "\n")
  SVæ•°é‡ï¼š 55803 
> cat("  ç¯å¢ƒå› å­ï¼š", num_env_factors, "ä¸ªï¼ˆBIO1-BIO19ï¼‰\n")
  ç¯å¢ƒå› å­ï¼š 19 ä¸ªï¼ˆBIO1-BIO19ï¼‰
> cat("  Kå€¼ï¼š", K, "\n")
  Kå€¼ï¼š 6 
> cat("  GIFå€¼ï¼š", round(pv$gif, 3), "\n\n")
  GIFå€¼ï¼š 1.871 2.005 2.277 1.92 0 0 0 1.764 1.569 2 1.676 2.261 1.997 2.005 1.957 2.087 1.821 2.421 2.289 

> cat("ğŸ“ˆ ç»“æœç»Ÿè®¡ï¼š\n")
ğŸ“ˆ ç»“æœç»Ÿè®¡ï¼š
> if (exists("significant_sv_count")) {
+   cat("  æ˜¾è‘—æ€§SVæ€»æ•°ï¼ˆFDR < 0.05ï¼‰ï¼š", significant_sv_count, "\n")
+   cat("  æ˜¾è‘—æ€§SVæ¯”ä¾‹ï¼š", round(significant_sv_count/length(sv_ids)*100, 2), "%\n")
+ } else {
+   cat("  æœªæ‰¾åˆ°æ˜¾è‘—æ€§SV\n")
+ }
  æ˜¾è‘—æ€§SVæ€»æ•°ï¼ˆFDR < 0.05ï¼‰ï¼š 1078 
  æ˜¾è‘—æ€§SVæ¯”ä¾‹ï¼š 1.93 %
> cat("\nğŸ“‹ å„ç¯å¢ƒå› å­æ˜¾è‘—æ€§SVæ•°é‡ï¼š\n")

ğŸ“‹ å„ç¯å¢ƒå› å­æ˜¾è‘—æ€§SVæ•°é‡ï¼š
> total_significant <- 0
> for (i in 1:num_env_factors) {
+   env_name <- env_factor_names[i]
+   count <- significant_counts[i, "Significant_SV_Count"]
+   total_significant <- total_significant + count
+   cat(sprintf("  %-10s: %6d ä¸ªæ˜¾è‘—æ€§SV\n", env_name, count))
+ }
  BIO1      :     57 ä¸ªæ˜¾è‘—æ€§SV
  BIO2      :    109 ä¸ªæ˜¾è‘—æ€§SV
  BIO3      :    282 ä¸ªæ˜¾è‘—æ€§SV
  BIO4      :      6 ä¸ªæ˜¾è‘—æ€§SV
  BIO5      :     43 ä¸ªæ˜¾è‘—æ€§SV
  BIO6      :     46 ä¸ªæ˜¾è‘—æ€§SV
  BIO7      :     39 ä¸ªæ˜¾è‘—æ€§SV
  BIO8      :     15 ä¸ªæ˜¾è‘—æ€§SV
  BIO9      :    176 ä¸ªæ˜¾è‘—æ€§SV
  BIO10     :     51 ä¸ªæ˜¾è‘—æ€§SV
  BIO11     :      5 ä¸ªæ˜¾è‘—æ€§SV
  BIO12     :     97 ä¸ªæ˜¾è‘—æ€§SV
  BIO13     :    100 ä¸ªæ˜¾è‘—æ€§SV
  BIO14     :     43 ä¸ªæ˜¾è‘—æ€§SV
  BIO15     :    160 ä¸ªæ˜¾è‘—æ€§SV
  BIO16     :    206 ä¸ªæ˜¾è‘—æ€§SV
  BIO17     :      0 ä¸ªæ˜¾è‘—æ€§SV
  BIO18     :    182 ä¸ªæ˜¾è‘—æ€§SV
  BIO19     :    261 ä¸ªæ˜¾è‘—æ€§SV
> cat(sprintf("\n  åˆè®¡ï¼š%d ä¸ªæ˜¾è‘—æ€§å…³è”\n", total_significant))

  åˆè®¡ï¼š1878 ä¸ªæ˜¾è‘—æ€§å…³è”
> cat("\nğŸ’¾ ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ–‡ä»¶ååŒ…å«'_corrected'ï¼‰ï¼š\n")

ğŸ’¾ ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ–‡ä»¶ååŒ…å«'_corrected'ï¼‰ï¼š
> files <- list.files(pattern = "_corrected\\.(csv|rds)$")
> if (length(files) > 0) {
+   file_count <- 0
+   for (file in files) {
+     if (file.exists(file)) {
+       file_size <- file.size(file)
+       cat(sprintf("  %-50s %8.1f KB\n", file, file_size/1024))
+       file_count <- file_count + 1
+     }
+   }
+   cat("\n  å…±ç”Ÿæˆ", file_count, "ä¸ªæ–‡ä»¶\n")
+ } else {
+   cat("  æš‚æ— æ–‡ä»¶\n")
+ }
  all_qvalues_SV_bio1_19_corrected.csv                19253.1 KB
  all_significant_SV_ids_union_bio1_19_corrected.csv     21.9 KB
  FDR_thresholds_SV_bio1_19_corrected.csv                 1.2 KB
  pv_results_200samples_SV_bio1_19_corrected.rds      50806.8 KB
  qvalues_BIO1_corrected.csv                           3108.2 KB
  qvalues_BIO10_corrected.csv                          3106.3 KB
  qvalues_BIO11_corrected.csv                          3107.0 KB
  qvalues_BIO12_corrected.csv                          3108.4 KB
  qvalues_BIO13_corrected.csv                          3106.6 KB
  qvalues_BIO14_corrected.csv                          3104.1 KB
  qvalues_BIO15_corrected.csv                          3108.6 KB
  qvalues_BIO16_corrected.csv                          3107.3 KB
  qvalues_BIO17_corrected.csv                          3105.8 KB
  qvalues_BIO18_corrected.csv                          3084.3 KB
  qvalues_BIO19_corrected.csv                          2682.6 KB
  qvalues_BIO2_corrected.csv                           3108.7 KB
  qvalues_BIO3_corrected.csv                           3106.6 KB
  qvalues_BIO4_corrected.csv                           3107.8 KB
  qvalues_BIO5_corrected.csv                           3108.0 KB
  qvalues_BIO6_corrected.csv                           3107.5 KB
  qvalues_BIO7_corrected.csv                           3099.5 KB
  qvalues_BIO8_corrected.csv                           3106.8 KB
  qvalues_BIO9_corrected.csv                           3101.1 KB
  significant_SV_counts_bio1_19_corrected.csv             0.3 KB
  significant_SV_ids_BIO1_FDR0.05_corrected.csv           1.2 KB
  significant_SV_ids_BIO10_FDR0.05_corrected.csv          1.1 KB
  significant_SV_ids_BIO11_FDR0.05_corrected.csv          0.1 KB
  significant_SV_ids_BIO12_FDR0.05_corrected.csv          2.0 KB
  significant_SV_ids_BIO13_FDR0.05_corrected.csv          2.0 KB
  significant_SV_ids_BIO14_FDR0.05_corrected.csv          0.9 KB
  significant_SV_ids_BIO15_FDR0.05_corrected.csv          3.3 KB
  significant_SV_ids_BIO16_FDR0.05_corrected.csv          4.2 KB
  significant_SV_ids_BIO18_FDR0.05_corrected.csv          3.7 KB
  significant_SV_ids_BIO19_FDR0.05_corrected.csv          5.2 KB
  significant_SV_ids_BIO2_FDR0.05_corrected.csv           2.3 KB
  significant_SV_ids_BIO3_FDR0.05_corrected.csv           5.7 KB
  significant_SV_ids_BIO4_FDR0.05_corrected.csv           0.1 KB
  significant_SV_ids_BIO5_FDR0.05_corrected.csv           0.9 KB
  significant_SV_ids_BIO6_FDR0.05_corrected.csv           1.0 KB
  significant_SV_ids_BIO7_FDR0.05_corrected.csv           0.8 KB
  significant_SV_ids_BIO8_FDR0.05_corrected.csv           0.3 KB
  significant_SV_ids_BIO9_FDR0.05_corrected.csv           3.6 KB
  significant_SVs_BIO1_FDR0.05_corrected.csv              3.5 KB
  significant_SVs_BIO10_FDR0.05_corrected.csv             3.1 KB
  significant_SVs_BIO11_FDR0.05_corrected.csv             0.3 KB
  significant_SVs_BIO12_FDR0.05_corrected.csv             5.8 KB
  significant_SVs_BIO13_FDR0.05_corrected.csv             6.0 KB
  significant_SVs_BIO14_FDR0.05_corrected.csv             2.6 KB
  significant_SVs_BIO15_FDR0.05_corrected.csv             9.6 KB
  significant_SVs_BIO16_FDR0.05_corrected.csv            12.4 KB
  significant_SVs_BIO18_FDR0.05_corrected.csv            10.9 KB
  significant_SVs_BIO19_FDR0.05_corrected.csv            15.5 KB
  significant_SVs_BIO2_FDR0.05_corrected.csv              6.7 KB
  significant_SVs_BIO3_FDR0.05_corrected.csv             17.0 KB
  significant_SVs_BIO4_FDR0.05_corrected.csv              0.4 KB
  significant_SVs_BIO5_FDR0.05_corrected.csv              2.7 KB
  significant_SVs_BIO6_FDR0.05_corrected.csv              2.8 KB
  significant_SVs_BIO7_FDR0.05_corrected.csv              2.4 KB
  significant_SVs_BIO8_FDR0.05_corrected.csv              0.9 KB
  significant_SVs_BIO9_FDR0.05_corrected.csv             10.6 KB
  SV_calibrated_pvalues_bio1_19_corrected.csv         19810.1 KB
  SV_raw_pvalues_bio1_19_corrected.csv                19981.6 KB

  å…±ç”Ÿæˆ 62 ä¸ªæ–‡ä»¶
> cat("\n", paste(rep("=", 70), collapse = ""), "\n")

 ====================================================================== 
> cat("åˆ†æå®Œæˆæ—¶é—´ï¼š", date(), "\n")
åˆ†æå®Œæˆæ—¶é—´ï¼š Tue Dec  2 16:21:53 2025 
> cat(paste(rep("=", 70), collapse = ""), "\n")
====================================================================== 
> # ä¿å­˜å·¥ä½œç©ºé—´
> save.image("LFMM_analysis_corrected.RData")
> cat("\nå·¥ä½œç©ºé—´å·²ä¿å­˜ä¸ºï¼šLFMM_analysis_corrected.RData\n")

å·¥ä½œç©ºé—´å·²ä¿å­˜ä¸ºï¼šLFMM_analysis_corrected.RData
> cat("æ‚¨å¯ä»¥ä½¿ç”¨ load('LFMM_analysis_corrected.RData') é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®\n")
æ‚¨å¯ä»¥ä½¿ç”¨ load('LFMM_analysis_corrected.RData') é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
> cat("\nâœ¨ åˆ†ææµç¨‹å…¨éƒ¨å®Œæˆï¼è¯·æŸ¥çœ‹å·¥ä½œç›®å½•ä¸­çš„ç»“æœæ–‡ä»¶ã€‚\n")

âœ¨ åˆ†ææµç¨‹å…¨éƒ¨å®Œæˆï¼è¯·æŸ¥çœ‹å·¥ä½œç›®å½•ä¸­çš„ç»“æœæ–‡ä»¶ã€‚
> # æœ€åï¼Œç‰¹åˆ«è®°å½•é‡å¤SVçš„å¤„ç†æƒ…å†µ
> dup_info_file <- "duplicate_SV_processing_info.txt"
> writeLines(c(
+   "é‡å¤SVå¤„ç†ä¿¡æ¯ï¼š",
+   paste("åˆ†ææ—¶é—´ï¼š", Sys.time()),
+   paste("é‡å¤SVä½ç½®ï¼š", length(which(grepl("_dup", sv_ids)))),
+   paste("åŸå§‹é‡å¤SVæ ‡è¯†ç¬¦ï¼š", ">10464698>10464724"),
+   paste("å¤„ç†åçš„æ ‡è¯†ç¬¦ï¼š"),
+   paste("  ", sv_ids[grepl(">10464698>10464724", sv_ids)])
+ ), dup_info_file)
> cat("\né‡å¤SVå¤„ç†ä¿¡æ¯å·²ä¿å­˜åˆ°ï¼š", dup_info_file, "\n")

é‡å¤SVå¤„ç†ä¿¡æ¯å·²ä¿å­˜åˆ°ï¼š duplicate_SV_processing_info.txt 
> 
> 
